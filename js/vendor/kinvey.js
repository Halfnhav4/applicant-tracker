/*! IndexedDBShim - v0.1.2 - 2013-04-21 */
var idbModules={};(function(e){function t(e,t,n,o){n.target=t,"function"==typeof t[e]&&t[e].apply(t,[n]),"function"==typeof o&&o()}function n(t,n,o){var i=new DOMException.constructor(0,n);throw i.name=t,i.message=n,i.stack=arguments.callee.caller,e.DEBUG&&console.log(t,n,o,i),i}var o=function(){this.length=0,this._items=[]};o.prototype={contains:function(e){return-1!==this._items.indexOf(e)},item:function(e){return this._items[e]},indexOf:function(e){return this._items.indexOf(e)},push:function(e){this._items.push(e),this.length+=1},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length}},e.util={throwDOMException:n,callback:t,quote:function(e){return"'"+e+"'"},StringList:o}})(idbModules),function(e){var t=function(){return{encode:function(e){return JSON.stringify(e)},decode:function(e){return JSON.parse(e)}}}();e.Sca=t}(idbModules),function(e){var t=["","number","string","boolean","object","undefined"],n=function(){return{encode:function(e){return t.indexOf(typeof e)+"-"+JSON.stringify(e)},decode:function(e){return e===void 0?void 0:JSON.parse(e.substring(2))}}},o={number:n("number"),"boolean":n(),object:n(),string:{encode:function(e){return t.indexOf("string")+"-"+e},decode:function(e){return""+e.substring(2)}},undefined:{encode:function(){return t.indexOf("undefined")+"-undefined"},decode:function(){return void 0}}},i=function(){return{encode:function(e){return o[typeof e].encode(e)},decode:function(e){return o[t[e.substring(0,1)]].decode(e)}}}();e.Key=i}(idbModules),function(e){var t=function(e,t){return{type:e,debug:t,bubbles:!1,cancelable:!1,eventPhase:0,timeStamp:new Date}};e.Event=t}(idbModules),function(e){var t=function(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"},n=function(){this.onblocked=this.onupgradeneeded=null};n.prototype=t,e.IDBRequest=t,e.IDBOpenRequest=n}(idbModules),function(e,t){var n=function(e,t,n,o){this.lower=e,this.upper=t,this.lowerOpen=n,this.upperOpen=o};n.only=function(e){return new n(e,e,!0,!0)},n.lowerBound=function(e,o){return new n(e,t,o,t)},n.upperBound=function(e){return new n(t,e,t,open)},n.bound=function(e,t,o,i){return new n(e,t,o,i)},e.IDBKeyRange=n}(idbModules),function(e,t){function n(n,o,i,r,s,a){this.__range=n,this.source=this.__idbObjectStore=i,this.__req=r,this.key=t,this.direction=o,this.__keyColumnName=s,this.__valueColumnName=a,this.source.transaction.__active||e.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active."),this.__offset=-1,this.__lastKeyContinued=t,this["continue"]()}n.prototype.__find=function(n,o,i,r){var s=this,a=["SELECT * FROM ",e.util.quote(s.__idbObjectStore.name)],u=[];a.push("WHERE ",s.__keyColumnName," NOT NULL"),s.__range&&(s.__range.lower||s.__range.upper)&&(a.push("AND"),s.__range.lower&&(a.push(s.__keyColumnName+(s.__range.lowerOpen?" >":" >= ")+" ?"),u.push(e.Key.encode(s.__range.lower))),s.__range.lower&&s.__range.upper&&a.push("AND"),s.__range.upper&&(a.push(s.__keyColumnName+(s.__range.upperOpen?" < ":" <= ")+" ?"),u.push(e.Key.encode(s.__range.upper)))),n!==t&&(s.__lastKeyContinued=n,s.__offset=0),s.__lastKeyContinued!==t&&(a.push("AND "+s.__keyColumnName+" >= ?"),u.push(e.Key.encode(s.__lastKeyContinued))),a.push("ORDER BY ",s.__keyColumnName),a.push("LIMIT 1 OFFSET "+s.__offset),e.DEBUG&&console.log(a.join(" "),u),o.executeSql(a.join(" "),u,function(n,o){if(1===o.rows.length){var r=e.Key.decode(o.rows.item(0)[s.__keyColumnName]),a="value"===s.__valueColumnName?e.Sca.decode(o.rows.item(0)[s.__valueColumnName]):e.Key.decode(o.rows.item(0)[s.__valueColumnName]);i(r,a)}else e.DEBUG&&console.log("Reached end of cursors"),i(t,t)},function(t,n){e.DEBUG&&console.log("Could not execute Cursor.continue"),r(n)})},n.prototype["continue"]=function(e){var n=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(o,i,r,s){n.__offset++,n.__find(e,o,function(e,o){n.key=e,n.value=o,r(n.key!==t?n:t,n.__req)},function(e){s(e)})})},n.prototype.advance=function(n){0>=n&&e.util.throwDOMException("Type Error - Count is invalid - 0 or negative",n);var o=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(e,i,r,s){o.__offset+=n,o.__find(t,e,function(e,n){o.key=e,o.value=n,r(o.key!==t?o:t,o.__req)},function(e){s(e)})})},n.prototype.update=function(n){var o=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(i,r,s,a){o.__find(t,i,function(t){var r="UPDATE "+e.util.quote(o.__idbObjectStore.name)+" SET value = ? WHERE key = ?";e.DEBUG&&console.log(r,n,t),i.executeSql(r,[e.Sca.encode(n),e.Key.encode(t)],function(e,n){1===n.rowsAffected?s(t):a("No rowns with key found"+t)},function(e,t){a(t)})},function(e){a(e)})})},n.prototype["delete"]=function(){var n=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(o,i,r,s){n.__find(t,o,function(i){var a="DELETE FROM  "+e.util.quote(n.__idbObjectStore.name)+" WHERE key = ?";e.DEBUG&&console.log(a,i),o.executeSql(a,[e.Key.encode(i)],function(e,n){1===n.rowsAffected?r(t):s("No rowns with key found"+i)},function(e,t){s(t)})},function(e){s(e)})})},e.IDBCursor=n}(idbModules),function(idbModules,undefined){function IDBIndex(e,t){this.indexName=this.name=e,this.__idbObjectStore=this.objectStore=this.source=t;var n=t.__storeProps&&t.__storeProps.indexList;n&&(n=JSON.parse(n)),this.keyPath=n&&n[e]&&n[e].keyPath||e,["multiEntry","unique"].forEach(function(t){this[t]=!!(n&&n[e]&&n[e].optionalParams&&n[e].optionalParams[t])},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this,transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(){idbModules.util.throwDOMException(0,"Could not create new index",arguments)}2!==transaction.mode&&idbModules.util.throwDOMException(0,"Invalid State error, not a version transaction",me.transaction);var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);idxList[indexName]!==undefined&&idbModules.util.throwDOMException(0,"Index already exists on store",idxList);var columnName=indexName;idxList[indexName]={columnName:columnName,keyPath:keyPath,optionalParams:optionalParameters},me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",columnName,"BLOB"].join(" ");idbModules.DEBUG&&console.log(sql),tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){(function initIndexForRow(i){if(data.rows.length>i)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+columnName+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else idbModules.DEBUG&&console.log("Updating the indexes in table",me.__idbObjectStore.__storeProps),tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",!0),success(me)},error)})(0)},error)},error)},"createObjectStore")})},IDBIndex.prototype.openCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this.source,n,this.indexName,"value"),n},IDBIndex.prototype.openKeyCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this.source,n,this.indexName,"key"),n},IDBIndex.prototype.__fetchIndexData=function(e,t){var n=this;return n.__idbObjectStore.transaction.__addToTransactionQueue(function(o,i,r,s){var a=["SELECT * FROM ",idbModules.util.quote(n.__idbObjectStore.name)," WHERE",n.indexName,"NOT NULL"],u=[];e!==undefined&&(a.push("AND",n.indexName," = ?"),u.push(idbModules.Key.encode(e))),idbModules.DEBUG&&console.log("Trying to fetch data for Index",a.join(" "),u),o.executeSql(a.join(" "),u,function(e,n){var o;o="count"==typeof t?n.rows.length:0===n.rows.length?undefined:"key"===t?idbModules.Key.decode(n.rows.item(0).key):idbModules.Sca.decode(n.rows.item(0).value),r(o)},s)})},IDBIndex.prototype.get=function(e){return this.__fetchIndexData(e,"value")},IDBIndex.prototype.getKey=function(e){return this.__fetchIndexData(e,"key")},IDBIndex.prototype.count=function(e){return this.__fetchIndexData(e,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){var IDBObjectStore=function(e,t,n){this.name=e,this.transaction=t,this.__ready={},this.__setReadyState("createObjectStore",n===void 0?!0:n),this.indexNames=new idbModules.util.StringList};IDBObjectStore.prototype.__setReadyState=function(e,t){this.__ready[e]=t},IDBObjectStore.prototype.__waitForReady=function(e,t){var n=!0;if(t!==void 0)n=this.__ready[t]===void 0?!0:this.__ready[t];else for(var o in this.__ready)this.__ready[o]||(n=!1);if(n)e();else{idbModules.DEBUG&&console.log("Waiting for to be ready",t);var i=this;window.setTimeout(function(){i.__waitForReady(e,t)},100)}},IDBObjectStore.prototype.__getStoreProps=function(e,t,n){var o=this;this.__waitForReady(function(){o.__storeProps?(idbModules.DEBUG&&console.log("Store properties - cached",o.__storeProps),t(o.__storeProps)):e.executeSql("SELECT * FROM __sys__ where name = ?",[o.name],function(e,n){1!==n.rows.length?t():(o.__storeProps={name:n.rows.item(0).name,indexList:n.rows.item(0).indexList,autoInc:n.rows.item(0).autoInc,keyPath:n.rows.item(0).keyPath},idbModules.DEBUG&&console.log("Store properties",o.__storeProps),t(o.__storeProps))},function(){t()})},n)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(e,t){1!==t.rows.length?callback(0):callback(t.rows.item(0).seq)},function(e,t){idbModules.util.throwDOMException(0,"Data Error - Could not get the auto increment value for key",t)})}var me=this;me.__getStoreProps(tx,function(props){if(props||idbModules.util.throwDOMException(0,"Data Error - Could not locate defination for this table",props),props.keyPath)if(key!==void 0&&idbModules.util.throwDOMException(0,"Data Error - The object store uses in-line keys and the key parameter was provided",props),value)try{var primaryKey=eval("value['"+props.keyPath+"']");primaryKey?callback(primaryKey):"true"===props.autoInc?getNextAutoIncKey():idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath")}catch(e){idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath",e)}else idbModules.util.throwDOMException(0,"Data Error - KeyPath was specified, but value was not");else key!==void 0?callback(key):"false"===props.autoInc?idbModules.util.throwDOMException(0,"Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props):getNextAutoIncKey()})},IDBObjectStore.prototype.__insertData=function(tx,value,primaryKey,success,error){var paramMap={};primaryKey!==void 0&&(paramMap.key=idbModules.Key.encode(primaryKey));var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes)try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(key in paramMap)sqlStart.push(key+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(idbModules.Sca.encode(value));var sql=sqlStart.join(" ")+sqlEnd.join(" ");idbModules.DEBUG&&console.log("SQL for adding",sql,sqlValues),tx.executeSql(sql,sqlValues,function(){success(primaryKey)},function(e,t){error(t)})},IDBObjectStore.prototype.add=function(e,t){var n=this;return n.transaction.__addToTransactionQueue(function(o,i,r,s){n.__deriveKey(o,e,t,function(t){n.__insertData(o,e,t,r,s)})})},IDBObjectStore.prototype.put=function(e,t){var n=this;return n.transaction.__addToTransactionQueue(function(o,i,r,s){n.__deriveKey(o,e,t,function(t){var i="DELETE FROM "+idbModules.util.quote(n.name)+" where key = ?";o.executeSql(i,[idbModules.Key.encode(t)],function(o,i){idbModules.DEBUG&&console.log("Did the row with the",t,"exist? ",i.rowsAffected),n.__insertData(o,e,t,r,s)},function(e,t){s(t)})})})},IDBObjectStore.prototype.get=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,o,i,r){t.__waitForReady(function(){var o=idbModules.Key.encode(e);idbModules.DEBUG&&console.log("Fetching",t.name,o),n.executeSql("SELECT * FROM "+idbModules.util.quote(t.name)+" where key = ?",[o],function(e,t){idbModules.DEBUG&&console.log("Fetched data",t);try{if(0===t.rows.length)return i();i(idbModules.Sca.decode(t.rows.item(0).value))}catch(n){idbModules.DEBUG&&console.log(n),i(void 0)}},function(e,t){r(t)})})})},IDBObjectStore.prototype["delete"]=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,o,i,r){t.__waitForReady(function(){var o=idbModules.Key.encode(e);idbModules.DEBUG&&console.log("Fetching",t.name,o),n.executeSql("DELETE FROM "+idbModules.util.quote(t.name)+" where key = ?",[o],function(e,t){idbModules.DEBUG&&console.log("Deleted from database",t.rowsAffected),i()},function(e,t){r(t)})})})},IDBObjectStore.prototype.clear=function(){var e=this;return e.transaction.__addToTransactionQueue(function(t,n,o,i){e.__waitForReady(function(){t.executeSql("DELETE FROM "+idbModules.util.quote(e.name),[],function(e,t){idbModules.DEBUG&&console.log("Cleared all records from database",t.rowsAffected),o()},function(e,t){i(t)})})})},IDBObjectStore.prototype.count=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,o,i,r){t.__waitForReady(function(){var o="SELECT * FROM "+idbModules.util.quote(t.name)+(e!==void 0?" WHERE key = ?":""),s=[];e!==void 0&&s.push(idbModules.Key.encode(e)),n.executeSql(o,s,function(e,t){i(t.rows.length)},function(e,t){r(t)})})})},IDBObjectStore.prototype.openCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this,n,"key","value"),n},IDBObjectStore.prototype.index=function(e){var t=new idbModules.IDBIndex(e,this);return t},IDBObjectStore.prototype.createIndex=function(e,t,n){var o=this;n=n||{},o.__setReadyState("createIndex",!1);var i=new idbModules.IDBIndex(e,o);return o.__waitForReady(function(){i.__createIndex(e,t,n)},"createObjectStore"),o.indexNames.push(e),i},IDBObjectStore.prototype.deleteIndex=function(e){var t=new idbModules.IDBIndex(e,this,!1);return t.__deleteIndex(e),t},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(e){var t=0,n=1,o=2,i=function(o,i,r){if("number"==typeof i)this.mode=i,2!==i&&e.DEBUG&&console.log("Mode should be a string, but was specified as ",i);else if("string"==typeof i)switch(i){case"readwrite":this.mode=n;break;case"readonly":this.mode=t;break;default:this.mode=t}this.storeNames="string"==typeof o?[o]:o;for(var s=0;this.storeNames.length>s;s++)r.objectStoreNames.contains(this.storeNames[s])||e.util.throwDOMException(0,"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",this.storeNames[s]);this.__active=!0,this.__running=!1,this.__requests=[],this.__aborted=!1,this.db=r,this.error=null,this.onabort=this.onerror=this.oncomplete=null};i.prototype.__executeRequests=function(){if(this.__running&&this.mode!==o)return e.DEBUG&&console.log("Looks like the request set is already running",this.mode),void 0;this.__running=!0;var t=this;window.setTimeout(function(){2===t.mode||t.__active||e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",t.__active),t.db.__db.transaction(function(n){function o(t,n){n&&(s.req=n),s.req.readyState="done",s.req.result=t,delete s.req.error;var o=e.Event("success");e.util.callback("onsuccess",s.req,o),a++,r()}function i(){s.req.readyState="done",s.req.error="DOMError";var t=e.Event("error",arguments);e.util.callback("onerror",s.req,t),a++,r()}function r(){return a>=t.__requests.length?(t.__active=!1,t.__requests=[],void 0):(s=t.__requests[a],s.op(n,s.args,o,i),void 0)}t.__tx=n;var s=null,a=0;try{r()}catch(u){e.DEBUG&&console.log("An exception occured in transaction",arguments),"function"==typeof t.onerror&&t.onerror()}},function(){e.DEBUG&&console.log("An error in transaction",arguments),"function"==typeof t.onerror&&t.onerror()},function(){e.DEBUG&&console.log("Transaction completed",arguments),"function"==typeof t.oncomplete&&t.oncomplete()})},1)},i.prototype.__addToTransactionQueue=function(t,n){this.__active||this.mode===o||e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished.",this.__mode);var i=new e.IDBRequest;return i.source=this.db,this.__requests.push({op:t,args:n,req:i}),this.__executeRequests(),i},i.prototype.objectStore=function(t){return new e.IDBObjectStore(t,this)},i.prototype.abort=function(){!this.__active&&e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",this.__active)},i.prototype.READ_ONLY=0,i.prototype.READ_WRITE=1,i.prototype.VERSION_CHANGE=2,e.IDBTransaction=i}(idbModules),function(e){var t=function(t,n,o,i){this.__db=t,this.version=o,this.__storeProperties=i,this.objectStoreNames=new e.util.StringList;for(var r=0;i.rows.length>r;r++)this.objectStoreNames.push(i.rows.item(r).name);this.name=n,this.onabort=this.onerror=this.onversionchange=null};t.prototype.createObjectStore=function(t,n){var o=this;n=n||{},n.keyPath=n.keyPath||null;var i=new e.IDBObjectStore(t,o.__versionTransaction,!1),r=o.__versionTransaction;return r.__addToTransactionQueue(function(r,s,a){function u(){e.util.throwDOMException(0,"Could not create new object store",arguments)}o.__versionTransaction||e.util.throwDOMException(0,"Invalid State error",o.transaction);var c=["CREATE TABLE",e.util.quote(t),"(key BLOB",n.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");e.DEBUG&&console.log(c),r.executeSql(c,[],function(e){e.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[t,n.keyPath,n.autoIncrement?!0:!1,"{}"],function(){i.__setReadyState("createObjectStore",!0),a(i)},u)},u)}),o.objectStoreNames.push(t),i},t.prototype.deleteObjectStore=function(t){var n=function(){e.util.throwDOMException(0,"Could not delete ObjectStore",arguments)},o=this;!o.objectStoreNames.contains(t)&&n("Object Store does not exist"),o.objectStoreNames.splice(o.objectStoreNames.indexOf(t),1);var i=o.__versionTransaction;i.__addToTransactionQueue(function(){o.__versionTransaction||e.util.throwDOMException(0,"Invalid State error",o.transaction),o.__db.transaction(function(o){o.executeSql("SELECT * FROM __sys__ where name = ?",[t],function(o,i){i.rows.length>0&&o.executeSql("DROP TABLE "+e.util.quote(t),[],function(){o.executeSql("DELETE FROM __sys__ WHERE name = ?",[t],function(){},n)},n)})})})},t.prototype.close=function(){},t.prototype.transaction=function(t,n){var o=new e.IDBTransaction(t,n||1,this);return o},e.IDBDatabase=t}(idbModules),function(e){var t=4194304;if(window.openDatabase){var n=window.openDatabase("__sysdb__",1,"System Database",t);n.transaction(function(t){t.executeSql("SELECT * FROM dbVersions",[],function(){},function(){n.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){},function(){e.util.throwDOMException("Could not create table __sysdb__ to save DB versions")})})})},function(){e.DEBUG&&console.log("Error in sysdb transaction - when selecting from dbVersions",arguments)});var o={open:function(o,i){function r(){if(!u){var t=e.Event("error",arguments);a.readyState="done",a.error="DOMError",e.util.callback("onerror",a,t),u=!0}}function s(s){var u=window.openDatabase(o,1,o,t);a.readyState="done",i===void 0&&(i=s||1),(0>=i||s>i)&&e.util.throwDOMException(0,"An attempt was made to open a database using a lower version than the existing version.",i),u.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){t.executeSql("SELECT * FROM __sys__",[],function(t,c){var d=e.Event("success");a.source=a.result=new e.IDBDatabase(u,o,i,c),i>s?n.transaction(function(t){t.executeSql("UPDATE dbVersions set version = ? where name = ?",[i,o],function(){var t=e.Event("upgradeneeded");t.oldVersion=s,t.newVersion=i,a.transaction=a.result.__versionTransaction=new e.IDBTransaction([],2,a.source),e.util.callback("onupgradeneeded",a,t,function(){var t=e.Event("success");e.util.callback("onsuccess",a,t)})},r)},r):e.util.callback("onsuccess",a,d)},r)},r)},r)}var a=new e.IDBOpenRequest,u=!1;return n.transaction(function(e){e.executeSql("SELECT * FROM dbVersions where name = ?",[o],function(e,t){0===t.rows.length?e.executeSql("INSERT INTO dbVersions VALUES (?,?)",[o,i||1],function(){s(0)},r):s(t.rows.item(0).version)},r)},r),a},deleteDatabase:function(o){function i(t){if(!a){s.readyState="done",s.error="DOMError";var n=e.Event("error");n.message=t,n.debug=arguments,e.util.callback("onerror",s,n),a=!0}}function r(){n.transaction(function(t){t.executeSql("DELETE FROM dbVersions where name = ? ",[o],function(){s.result=void 0;var t=e.Event("success");t.newVersion=null,t.oldVersion=u,e.util.callback("onsuccess",s,t)},i)},i)}var s=new e.IDBOpenRequest,a=!1,u=null;return n.transaction(function(n){n.executeSql("SELECT * FROM dbVersions where name = ?",[o],function(n,a){if(0===a.rows.length){s.result=void 0;var c=e.Event("success");return c.newVersion=null,c.oldVersion=u,e.util.callback("onsuccess",s,c),void 0}u=a.rows.item(0).version;var d=window.openDatabase(o,1,o,t);d.transaction(function(t){t.executeSql("SELECT * FROM __sys__",[],function(t,n){var o=n.rows;(function s(n){n>=o.length?t.executeSql("DROP TABLE __sys__",[],function(){r()},i):t.executeSql("DROP TABLE "+e.util.quote(o.item(n).name),[],function(){s(n+1)},function(){s(n+1)})})(0)},function(){r()})},i)})},i),s},cmp:function(t,n){return e.Key.encode(t)>e.Key.encode(n)?1:t===n?0:-1}};e.shimIndexedDB=o}}(idbModules),function(e,t){e.openDatabase!==void 0&&(e.shimIndexedDB=t.shimIndexedDB,e.shimIndexedDB&&(e.shimIndexedDB.__useShim=function(){e.indexedDB=t.shimIndexedDB,e.IDBDatabase=t.IDBDatabase,e.IDBTransaction=t.IDBTransaction,e.IDBCursor=t.IDBCursor,e.IDBKeyRange=t.IDBKeyRange},e.shimIndexedDB.__debug=function(e){t.DEBUG=e})),e.indexedDB=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,e.indexedDB===void 0&&e.openDatabase!==void 0?e.shimIndexedDB.__useShim():(e.IDBDatabase=e.IDBDatabase||e.webkitIDBDatabase,e.IDBTransaction=e.IDBTransaction||e.webkitIDBTransaction,e.IDBCursor=e.IDBCursor||e.webkitIDBCursor,e.IDBKeyRange=e.IDBKeyRange||e.webkitIDBKeyRange,e.IDBTransaction||(e.IDBTransaction={}),e.IDBTransaction.READ_ONLY=e.IDBTransaction.READ_ONLY||"readonly",e.IDBTransaction.READ_WRITE=e.IDBTransaction.READ_WRITE||"readwrite")}(window,idbModules);
//@ sourceMappingURL=http://nparashuram.com/IndexedDBShim/dist/IndexedDBShim.min.map;
/** @license MIT - Â©2013 Ruben Verborgh */
(function(){function e(){var c=function(u,f,i){if(u!==c){var v=e();return c.c.push({d:v,resolve:u,reject:f}),v.promise}for(var s=f?"resolve":"reject",a=0,p=c.c.length;p>a;a++){var h=c.c[a],l=h.d,j=h[s];typeof j!==t?l[s](i):n(j,i,l)}c=r(o,i,f)},o={then:function(e,r){return c(e,r)}};return c.c=[],{promise:o,resolve:function(e){c.c&&c(c,!0,e)},reject:function(e){c.c&&c(c,!1,e)}}}function r(r,c,o){return function(u,f){var i,v=o?u:f;return typeof v!==t?r:(n(v,c,i=e()),i.promise)}}function n(e,r,n){setTimeout(function(){try{var c=e(r);c&&typeof c.then===t?c.then(n.resolve,n.reject):n.resolve(c)}catch(o){n.reject(o)}})}var t="function";window.promiscuous={resolve:function(e){var n={};return n.then=r(n,e,!0),n},reject:function(e){var n={};return n.then=r(n,e,!1),n},deferred:e}})();;
(function(){var l=new function(){function d(a){return a?0:-1}var f=this.priority=function(a,b){for(var c=a.exprs,e=0,f=0,d=c.length;f<d;f++){var g=c[f];if(!~(g=g.e(g.v,b instanceof Date?b.getTime():b,b)))return-1;e+=g}return e},e=this.parse=function(a,b){a||(a={$eq:a});var c=[];if(a.constructor==Object)for(var d in a){var m=k[d]?d:"$trav",j=a[d],g=j;if(h[m]){if(~d.indexOf(".")){g=d.split(".");d=g.shift();for(var n={},l=n,p=0,s=g.length-1;p<s;p++)l=l[g[p]]={};l[g[p]]=j;g=j=n}if(j instanceof Array){g=
[];for(n=j.length;n--;)g.push(e(j[n]))}else g=e(j,d)}c.push(r(m,d,g))}else c.push(r("$eq",d,a));var q={exprs:c,k:b,test:function(a){return!!~q.priority(a)},priority:function(a){return f(q,a)}};return q},h=this.traversable={$and:!0,$or:!0,$nor:!0,$trav:!0,$not:!0},k=this.testers={$eq:function(a,b){return d(a.test(b))},$ne:function(a,b){return d(!a.test(b))},$lt:function(a,b){return a>b?0:-1},$gt:function(a,b){return a<b?0:-1},$lte:function(a,b){return a>=b?0:-1},$gte:function(a,b){return a<=b?0:-1},
$exists:function(a,b){return a===(null!=b)?0:-1},$in:function(a,b){if(b instanceof Array)for(var c=b.length;c--;){if(~a.indexOf(b[c]))return c}else return d(~a.indexOf(b));return-1},$not:function(a,b){if(!a.test)throw Error("$not test should include an expression, not a value. Use $ne instead.");return d(!a.test(b))},$type:function(a,b,c){return c?c instanceof a||c.constructor==a?0:-1:-1},$nin:function(a,b){return~k.$in(a,b)?-1:0},$mod:function(a,b){return b%a[0]==a[1]?0:-1},$all:function(a,b){for(var c=
a.length;c--;)if(-1==b.indexOf(a[c]))return-1;return 0},$size:function(a,b){return b?a==b.length?0:-1:-1},$or:function(a,b){for(var c=a.length,d=c;c--;)if(~f(a[c],b))return c;return 0==d?0:-1},$nor:function(a,b){for(var c=a.length;c--;)if(~f(a[c],b))return-1;return 0},$and:function(a,b){for(var c=a.length;c--;)if(!~f(a[c],b))return-1;return 0},$trav:function(a,b){if(b instanceof Array){for(var c=b.length;c--;){var d=b[c];if(d[a.k]&&~f(a,d[a.k]))return c}return-1}return f(a,b?b[a.k]:void 0)}},m={$eq:function(a){return a instanceof
RegExp?a:{test:a instanceof Function?a:function(b){return b instanceof Array?~b.indexOf(a):a==b}}},$ne:function(a){return m.$eq(a)}},r=function(a,b,c){c=c instanceof Date?c.getTime():c;return{k:b,v:m[a]?m[a](c):c,e:k[a]}}},h=function(d,f,e){"object"!=typeof f&&(e=f,f=void 0);if(e){if("function"!=typeof e)throw Error("Unknown sift selector "+e);}else e=function(d){return d};var h=e,k=l.parse(d);e=function(d){for(var e=[],a,b,c=0,f=d.length;c<f;c++)a=h(d[c]),~(b=k.priority(a))&&e.push({value:a,priority:b});
e.sort(function(a,b){return a.priority>b.priority?-1:1});d=Array(e.length);for(c=e.length;c--;)d[c]=e[c].value;return d};e.test=k.test;e.score=k.priority;e.query=d;return f?e(f):e};h.use=function(d){d.operators&&h.useOperators(d.operators)};h.useOperators=function(d){for(var f in d)h.useOperator(f,d[f])};h.useOperator=function(d,f){var e={},e="object"==typeof f?f:{test:f},h="$"+d;l.testers[h]=e.test;if(e.traversable||e.traverse)l.traversable[h]=!0};"undefined"!=typeof module&&"undefined"!=typeof module.exports?
module.exports=h:"undefined"!=typeof window&&(window.sift=h)})();
;
/*!
 * Copyright (c) 2013 Kinvey, Inc. All rights reserved.
 *
 * Licensed to Kinvey, Inc. under one or more contributor
 * license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership.  Kinvey, Inc. licenses this file to you under the
 * Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You
 * may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
(function(){var e=this,r=function(){var t=function(e){var t=r();return null!=e&&t.init(e),t};t.API_ENDPOINT="https://baas.kinvey.com",t.API_VERSION="2",t.SDK_VERSION="1.0.0-beta",t.appKey=null,t.appSecret=null,t.masterSecret=null;var n="appdata",o="blob",i="rpc",u="user",a=null,s=function(){var e=R.get("activeUser");return e.then(function(e){if(null!=e){var r=t.setActiveUser({_kmd:{authtoken:e}});return t.User.me().then(null,function(e){return t.setActiveUser(r),t.Defer.reject(e)})}return t.getActiveUser()})};t.getActiveUser=function(){return a},t.setActiveUser=function(e){if(null!=e&&(null==e._kmd||null==e._kmd.authtoken))throw new t.Error("user argument must contain: _kmd.authtoken.");var r=t.getActiveUser();return a=e,null!=e?R.save("activeUser",e._kmd.authtoken):R.destroy("activeUser"),r},t.init=function(e){if(e=e||{},null==e.appKey)throw new t.Error("options argument must contain: appKey.");if(null==e.appSecret&&null==e.masterSecret)throw new t.Error("options argument must contain: appSecret and/or masterSecret.");t.appKey=e.appKey,t.appSecret=null!=e.appSecret?e.appSecret:null,t.masterSecret=null!=e.masterSecret?e.masterSecret:null;var r=t.Sync.init(e.sync).then(s);return f(r,e)},t.ping=function(e){e=e||{},e.nocache=null==t.appKey?!1:e.nocache;var r=t.Persistence.read({namespace:n,auth:null!=t.appKey?A.All:A.None},e);return f(r,e)},t.Error=function(e){this.name="Kinvey.Error",this.message=e,this.stack=Error().stack},t.Error.prototype=Error(),t.Error.prototype.constructor=t.Error,t.Error.ENTITY_NOT_FOUND="EntityNotFound",t.Error.COLLECTION_NOT_FOUND="CollectionNotFound",t.Error.APP_NOT_FOUND="AppNotFound",t.Error.USER_NOT_FOUND="UserNotFound",t.Error.BLOB_NOT_FOUND="BlobNotFound",t.Error.INVALID_CREDENTIALS="InvalidCredentials",t.Error.KINVEY_INTERNAL_ERROR_RETRY="KinveyInternalErrorRetry",t.Error.KINVEY_INTERNAL_ERROR_STOP="KinveyInternalErrorStop",t.Error.USER_ALREADY_EXISTS="UserAlreadyExists",t.Error.USER_UNAVAILABLE="UserUnavailable",t.Error.DUPLICATE_END_USERS="DuplicateEndUsers",t.Error.INSUFFICIENT_CREDENTIALS="InsufficientCredentials",t.Error.WRITES_TO_COLLECTION_DISALLOWED="WritesToCollectionDisallowed",t.Error.INDIRECT_COLLECTION_ACCESS_DISALLOWED="IndirectCollectionAccessDisallowed",t.Error.APP_PROBLEM="AppProblem",t.Error.PARAMETER_VALUE_OUT_OF_RANGE="ParameterValueOutOfRange",t.Error.CORS_DISABLED="CORSDisabled",t.Error.INVALID_QUERY_SYNTAX="InvalidQuerySyntax",t.Error.MISSING_QUERY="MissingQuery",t.Error.JSON_PARSE_ERROR="JSONParseError",t.Error.MISSING_REQUEST_HEADER="MissingRequestHeader",t.Error.INCOMPLETE_REQUEST_BODY="IncompleteRequestBody",t.Error.MISSING_REQUEST_PARAMETER="MissingRequestParameter",t.Error.INVALID_IDENTIFIER="InvalidIdentifier",t.Error.BAD_REQUEST="BadRequest",t.Error.FEATURE_UNAVAILABLE="FeatureUnavailable",t.Error.API_VERSION_NOT_IMPLEMENTED="APIVersionNotImplemented",t.Error.API_VERSION_NOT_AVAILABLE="APIVersionNotAvailable",t.Error.INPUT_VALIDATION_FAILED="InputValidationFailed",t.Error.BL_RUNTIME_ERROR="BLRuntimeError",t.Error.BL_SYNTAX_ERROR="BLSyntaxError",t.Error.BL_TIMEOUT_ERROR="BLTimeoutError",t.Error.OAUTH_TOKEN_REFRESH_ERROR="OAuthTokenRefreshError",t.Error.BL_VIOLATION_ERROR="BLViolationError",t.Error.BL_INTERNAL_ERROR="BLInternalError",t.Error.THIRD_PARTY_TOS_UNACKED="ThirdPartyTOSUnacked",t.Error.STALE_REQUEST="StaleRequest",t.Error.DATA_LINK_PARSE_ERROR="DataLinkParseError",t.Error.NOT_IMPLEMENTED_ERROR="NotImplementedError",t.Error.DATABASE_ERROR="DatabaseError",t.Error.MISSING_APP_CREDENTIALS="MissingAppCredentials",t.Error.MISSING_MASTER_CREDENTIALS="MissingMasterCredentials",t.Error.NO_ACTIVE_USER="NoActiveUser",t.Error.REQUEST_ABORT_ERROR="RequestAbortError",t.Error.REQUEST_ERROR="RequestError",t.Error.REQUEST_TIMEOUT_ERROR="RequestTimeoutError",t.Error.SOCIAL_ERROR="SocialError",t.Error.SYNC_ERROR="SyncError";var c={};c[t.Error.DATABASE_ERROR]={name:t.Error.DATABASE_ERROR,description:"The database used for local persistence encountered an error.",debug:""},c[t.Error.MISSING_APP_CREDENTIALS]={name:t.Error.MISSING_APP_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.appSecret`.",debug:"Did you forget to call `Kinvey.init`?"},c[t.Error.MISSING_MASTER_CREDENTIALS]={name:t.Error.MISSING_MASTER_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.masterSecret`.",debug:"Did you forget to call `Kinvey.init` with your Master Secret?"},c[t.Error.NO_ACTIVE_USER]={name:t.Error.NO_ACTIVE_USER,description:"No active user.",debug:"Try creating a user or logging in first."},c[t.Error.REQUEST_ABORT_ERROR]={name:t.Error.REQUEST_TIMEOUT_ERROR,description:"The request was aborted.",debug:""},c[t.Error.REQUEST_ERROR]={name:t.Error.REQUEST_ERROR,description:"The request failed.",debug:""},c[t.Error.REQUEST_TIMEOUT_ERROR]={name:t.Error.REQUEST_TIMEOUT_ERROR,description:"The request timed out.",debug:""},c[t.Error.SOCIAL_ERROR]={name:t.Error.SOCIAL_ERROR,description:"The social identity cannot be obtained.",debug:""},c[t.Error.SYNC_ERROR]={name:t.Error.SYNC_ERROR,description:"The synchronization operation cannot be completed.",debug:""};var l=function(e,r){var t=c[e]||{name:e};return r=r||{},{name:t.name,description:r.description||t.description||"",debug:r.debug||t.debug||""}},f=function(e,r){return e.then(function(e){r.success&&r.success(e)},function(e){r.error&&r.error(e)}),e},d=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},p=function(e){return"function"==typeof e},h=function(e){return"[object Number]"===Object.prototype.toString.call(e)&&!isNaN(e)},m=function(e){return Object(e)===e},v=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},E=function(e){return"[object String]"===Object.prototype.toString.call(e)},y=function(e){if(null==e)return!0;if(d(e)||E(e))return 0===e.length;for(var r in e)if(e.hasOwnProperty(r))return!1;return!0},g=function(e){return function(){throw new t.Error("Method not implemented: "+e)}},b=function(e){return function(r){var n=this;r=r||{},e.forEach(function(e){if("function"!=typeof r[e])throw new t.Error("Adapter must implement method: "+e)}),e.forEach(function(e){n[e]=function(){return r[e].apply(r,arguments)}})}},R={destroy:function(e){return R._destroy(R._key(e))},get:function(e){return R._get(R._key(e))},save:function(e,r){return R._save(R._key(e),r)},_destroy:g("Storage.destroy"),_get:g("Storage.get"),_key:function(e){return["Kinvey",t.appKey,e].join(".")},_save:g("Storage.set"),use:b(["_destroy","_get","_save"])};t.Defer={all:function(e){if(!d(e))throw new t.Error("promises argument must be of type: Array.");var r=e.length;if(0===r)return t.Defer.resolve([]);var n=t.Defer.deferred(),o=[];return e.forEach(function(e,t){e.then(function(e){r-=1,o[t]=e,0===r&&n.resolve(o)},function(e){n.reject(e)})}),n.promise},resolve:function(e){var r=t.Defer.deferred();return r.resolve(e),r.promise},reject:function(e){var r=t.Defer.deferred();return r.reject(e),r.promise},deferred:g("Kinvey.Defer.deferred"),use:b(["deferred"])};var S=null,A={All:function(){return A.Session().then(null,A.Basic)},App:function(){if(null==t.appKey||null==t.appSecret){var e=l(t.Error.MISSING_APP_CREDENTIALS);return t.Defer.reject(e)}var r=t.Defer.resolve({scheme:"Basic",username:t.appKey,password:t.appSecret});return r},Basic:function(){return A.Master().then(null,A.App)},Default:function(){return A.UserDefault().then(null,function(){return null===S&&(S=t.User.create().then(function(e){return S=null,e},function(e){return S=null,t.Defer.reject(e)})),S.then(A.Session)})},Master:function(){if(null==t.appKey||null==t.masterSecret){var e=l(t.Error.MISSING_MASTER_CREDENTIALS);return t.Defer.reject(e)}var r=t.Defer.resolve({scheme:"Basic",username:t.appKey,password:t.masterSecret});return r},None:function(){return t.Defer.resolve(null)},Session:function(){var e=t.getActiveUser();if(null===e){var r=l(t.Error.NO_ACTIVE_USER);return t.Defer.reject(r)}var n=t.Defer.resolve({scheme:"Kinvey",credentials:e._kmd.authtoken});return n},UserDefault:function(){return A.Session().then(null,A.Master)}};t.Acl=function(e){if(null!=e&&!m(e))throw new t.Error("document argument must be of type: Object.");e=e||{},e._acl=e._acl||{},this._acl=e._acl},t.Acl.prototype={addReader:function(e){return this._acl.r=this._acl.r||[],-1===this._acl.r.indexOf(e)&&this._acl.r.push(e),this},addReaderGroup:function(e){return this._acl.groups=this._acl.groups||{},this._acl.groups.r=this._acl.groups.r||[],-1===this._acl.groups.r.indexOf(e)&&this._acl.groups.r.push(e),this},addWriterGroup:function(e){return this._acl.groups=this._acl.groups||{},this._acl.groups.w=this._acl.groups.w||[],-1===this._acl.groups.w.indexOf(e)&&this._acl.groups.w.push(e),this},addWriter:function(e){return this._acl.w=this._acl.w||[],-1===this._acl.w.indexOf(e)&&this._acl.w.push(e),this},getCreator:function(){return this._acl.creator||null},getReaders:function(){return this._acl.r||[]},getReaderGroups:function(){return this._acl.groups?this._acl.groups.r:[]},getWriterGroups:function(){return this._acl.groups?this._acl.groups.w:[]},getWriters:function(){return this._acl.w||[]},isGloballyReadable:function(){return this._acl.gr||!1},isGloballyWritable:function(){return this._acl.gw||!1},removeReader:function(e){var r;return this._acl.r&&-1!==(r=this._acl.r.indexOf(e))&&this._acl.r.splice(r,1),this},removeReaderGroup:function(e){var r;return this._acl.groups&&this._acl.groups.r&&-1!==(r=this._acl.groups.r.indexOf(e))&&this._acl.groups.r.splice(r,1),this},removeWriterGroup:function(e){var r;return this._acl.groups&&this._acl.groups.w&&-1!==(r=this._acl.groups.w.indexOf(e))&&this._acl.groups.w.splice(r,1),this},removeWriter:function(e){var r;return this._acl.w&&-1!==(r=this._acl.w.indexOf(e))&&this._acl.w.splice(r,1),this},setGloballyReadable:function(e){return this._acl.gr=e||!1,this},setGloballyWritable:function(e){return this._acl.gw=e||!1,this},toJSON:function(){return this._acl}},t.Group=function(){this._query=null,this._initial={},this._key={},this._reduce=""+function(){}},t.Group.prototype={by:function(e){return this._key[e]=!0,this},initial:function(e,r){if(r===void 0&&!m(e))throw new t.Error("objectOrKey argument must be of type: Object.");return m(e)?this._initial=e:this._initial[e]=r,this},postProcess:function(e){return null===this._query?e:this._query._postProcess(e)},query:function(e){if(!(e instanceof t.Query))throw new t.Error("query argument must be of type: Kinvey.Query.");return this._query=e,this},reduce:function(e){if(p(e)&&(e=""+e),!E(e))throw new t.Error("fn argument must be of type: function or string.");return this._reduce=e,this},toJSON:function(){return{key:this._key,initial:this._initial,reduce:this._reduce,condition:null!==this._query?this._query.toJSON().filter:{}}}},t.Group.count=function(e){var r=new t.Group;return null!=e&&r.by(e),r.initial({result:0}),r.reduce(function(e,r){r.result+=1}),r},t.Group.sum=function(e){e=e.replace("'","\\'");var r=new t.Group;return r.initial({result:0}),r.reduce('function(doc, out) { out.result += doc["'+e+'"]; }'),r},t.Group.min=function(e){e=e.replace("'","\\'");var r=new t.Group;return r.initial({result:"Infinity"}),r.reduce('function(doc, out) { out.result = Math.min(out.result, doc["'+e+'"]); }'),r},t.Group.max=function(e){e=e.replace("'","\\'");var r=new t.Group;return r.initial({result:"-Infinity"}),r.reduce('function(doc, out) { out.result = Math.max(out.result, doc["'+e+'"]); }'),r},t.Group.average=function(e){e=e.replace("'","\\'");var r=new t.Group;return r.initial({count:0,result:0}),r.reduce('function(doc, out) {  out.result = (out.result * out.count + doc["'+e+'"]) / (out.count + 1);'+"  out.count += 1;"+"}"),r},t.DataStore={find:function(e,r,o){if(null!=r&&!(r instanceof t.Query))throw new t.Error("query argument must be of type: Kinvey.Query.");o=o||{};var i=t.Persistence.read({namespace:n,collection:e,query:r||null,auth:A.Default,local:{req:!0,res:!0}},o);return f(i,o)},get:function(e,r,o){o=o||{};var i=t.Persistence.read({namespace:n,collection:e,id:r,auth:A.Default,local:{req:!0,res:!0}},o);return f(i,o)},save:function(e,r,o){if(o=o||{},null!=r._id)return t.DataStore.update(e,r,o);var i=t.Persistence.create({namespace:n,collection:e,data:r,auth:A.Default,local:{req:!0,res:!0}},o);return f(i,o)},update:function(e,r,o){if(null==r._id)throw new t.Error("document argument must contain: _id");o=o||{};var i=t.Persistence.update({namespace:n,collection:e,id:r._id,data:r,auth:A.Default,local:{req:!0,res:!0}},o);return f(i,o)},clean:function(e,r,o){if(o=o||{},r=r||new t.Query,!(r instanceof t.Query))throw new t.Error("query argument must be of type: Kinvey.Query.");var i=t.Persistence.destroy({namespace:n,collection:e,query:r,auth:A.Default,local:{req:!0,res:!0}},o);return f(i,o)},destroy:function(e,r,o){o=o||{};var i=t.Persistence.destroy({namespace:n,collection:e,id:r,auth:A.Default,local:{req:!0,res:!0}},o).then(null,function(e){return o.silent&&t.Error.ENTITY_NOT_FOUND===e.name?{count:0}:t.Defer.reject(e)});return f(i,o)},count:function(e,r,o){if(null!=r&&!(r instanceof t.Query))throw new t.Error("query argument must be of type: Kinvey.Query.");o=o||{};var i=t.Persistence.read({namespace:n,collection:e,id:"_count",query:r||null,auth:A.Default,local:{req:!0}},o).then(function(e){return e.count});return f(i,o)},group:function(e,r,o){if(!(r instanceof t.Group))throw new t.Error("aggregation argument must be of type: Kinvey.Group.");o=o||{};var i=t.Persistence.create({namespace:n,collection:e,id:"_group",data:r.toJSON(),auth:A.Default,local:{req:!0}},o).then(function(e){return r.postProcess(e)});return f(i,o)}},t.File={destroy:function(e,r){r=r||{};var n=t.Persistence.read({namespace:o,collection:"remove-loc",id:e,auth:A.Default},r).then(function(e){return t.File._destroy(e.URI)},function(e){return r.silent&&t.Error.BLOB_NOT_FOUND===e.name?null:t.Defer.reject(e)});return f(n,r)},download:function(e,r){r=r||{};var n=t.Persistence.read({namespace:o,collection:"download-loc",id:e,auth:A.Default},r).then(function(e){return r.stream?e.URI:t.File._download(e.URI,r)});return f(n,r)},stream:function(e,r){return r=r||{},r.stream=!0,t.File.download(e,r)},upload:function(e,r,n){n=n||{},n.encode&&(r=t.Persistence.Net.base64(r));var i=t.Persistence.read({namespace:o,collection:"upload-loc",id:e,auth:A.Default},n).then(function(e){return t.File._upload(r,e.URI,n)});return f(i,n)},_destroy:g("Kinvey.File._destroy"),_download:g("Kinvey.File._download"),_upload:g("Kinvey.File._upload"),use:b(["_destroy","_download","_upload"])},t.Metadata=function(e){if(!m(e))throw new t.Error("document argument must be of type: Object.");this._acl=null,this._document=e},t.Metadata.prototype={getAcl:function(){return null===this._acl&&(this._acl=new t.Acl(this._document)),this._acl},getCreatedAt:function(){return null!=this._document._kmd&&null!=this._document._kmd.ect?new Date(this._document._kmd.ect):null},getEmailVerification:function(){return null!=this._document._kmd&&null!=this._document._kmd.emailVerification?this._document._kmd.emailVerification.status:null},getLastModified:function(){return null!=this._document._kmd&&null!=this._document._kmd.lmt?new Date(this._document._kmd.lmt):null},setAcl:function(e){if(!(e instanceof t.Acl))throw new t.Error("acl argument must be of type: Kinvey.Acl.");return this._acl=null,this._document._acl=e.toJSON(),this},toJSON:function(){return this._document}};var D=function(e,r,t){if(!r)return e=t===void 0?e:t;for(var n,o=e,i=r.split(".");(n=i.shift())&&null!=o&&o.hasOwnProperty(n);){if(0===i.length)return o[n]=t===void 0?o[n]:t,o[n];o=o[n]}return null},O={get:function(e,r){if(d(e)){var n=e.map(function(e){return O.get(e,r)});return t.Defer.all(n)}r=r||{},r.exclude=r.exclude||[],r.relations=r.relations||{};var o=r.error,i=r.relations,a=r.success;delete r.error,delete r.relations,delete r.success;var s=[];Object.keys(i).forEach(function(e){var r=e.split(".").length;s[r]=(s[r]||[]).concat(e)});var c=t.Defer.resolve(null);return s.forEach(function(n){c=c.then(function(){var o=n.map(function(n){var o=D(e,n),i=d(o),a=(i?o:[o]).map(function(e){if(null==e||"KinveyRef"!==e._type||-1!==r.exclude.indexOf(n))return t.Defer.resolve(e);var o;return o=u===e._collection?t.User.get(e._id,r):t.DataStore.get(e._collection,e._id,r),o.then(null,function(){return t.Defer.resolve(e)})});return t.Defer.all(a).then(function(r){D(e,n,i?r:r[0])})});return t.Defer.all(o)})}),c.then(function(){return r.error=o,r.relations=i,r.success=a,e},function(e){return r.error=o,r.relations=i,r.success=a,t.Defer.reject(e)})},save:function(e,r,n){if(d(r)){var o=r.map(function(r){return O.save(e,r,n)});return t.Defer.all(o)}n=n||{},n.exclude=n.exclude||[],n.relations=n.relations||{};var i=n.error,a=n.relations,s=n.success;delete n.error,delete n.relations,delete n.success;var c=[];a[""]=e,Object.keys(a).forEach(function(e){var r=""===e?0:e.split(".").length;c[r]=(c[r]||[]).concat(e)});var l={},f=t.Defer.resolve(null);return c.reverse().forEach(function(e){f=f.then(function(){var o=e.map(function(e){var o=a[e],i=D(r,e),s=d(i),c=(s?i:[i]).map(function(r){if(null==r||"KinveyRef"===r._type||-1!==n.exclude.indexOf(e))return t.Defer.resolve(r);var i;if(u===o){var a=null==r._id;n.state=a&&""!==e?n.state||!1:n.state,i=t.User[a?"create":"update"](r,n)}else i=t.DataStore.save(o,r,n);return i.then(null,function(o){return n.force&&""!==e?r:t.Defer.reject(o)})});return t.Defer.all(c).then(function(t){var n=t.map(function(e){return null==e||null==e._id?e:{_type:"KinveyRef",_collection:o,_id:e._id}});s||(n=n[0],t=t[0]),D(r,e,n),l[e]=t})});return t.Defer.all(o)})}),f.then(function(){var e=l[""];return c.reverse().forEach(function(r){r.forEach(function(r){D(e,r,l[r])})}),delete a[""],n.error=i,n.relations=a,n.success=s,e},function(e){return delete a[""],n.error=i,n.relations=a,n.success=s,t.Defer.reject(e)})}},N={facebook:2,google:2,linkedIn:1,twitter:1};t.Social={connect:function(e,r,n){if(n=n||{},n.create=n.create!==void 0?n.create:!0,!t.Social.isSupported(r))throw new t.Error("provider argument is not supported.");var o=n.success,i=n.error;delete n.success,delete n.error;var u=1===N[r]?"oAuth1":"oAuth2",a=t.Social[u](r,n).then(function(o){e=e||{};var i=t.getActiveUser();return e._socialIdentity=e._socialIdentity||{},e._socialIdentity[r]=o,null!==i&&i._id===e._id?(n._provider=r,t.User.update(e,n)):(e._socialIdentity={},e._socialIdentity[r]=o,t.User.login(e,null,n).then(null,function(r){return n.create&&t.Error.USER_NOT_FOUND===r.name?t.User.signup(e,n):t.Defer.reject(r)}))});return a=a.then(function(e){return n.success=o,n.error=i,e}),f(a,n)},disconnect:function(e,r,n){if(!t.Social.isSupported(r))throw new t.Error("provider argument is not supported.");if(e._socialIdentity=e._socialIdentity||{},e._socialIdentity[r]=null,null==e._id){var o=t.Defer.resolve(e);return f(o,n)}return t.User.update(e,n)},facebook:function(e,r){return t.Social.connect(e,"facebook",r)},google:function(e,r){return t.Social.connect(e,"google",r)},isSupported:function(e){return N.hasOwnProperty(e)},linkedIn:function(e,r){return t.Social.connect(e,"linkedIn",r)},twitter:function(e,r){return t.Social.connect(e,"twitter",r)},oAuth1:g("Kinvey.Social.oAuth1"),oAuth2:g("Kinvey.Social.oAuth2"),use:b(["oAuth1","oAuth2"])},t.User={signup:function(e,r){return r=r||{},r.state=!0,t.User.create(e,r)},login:function(e,r,n){return n=n||{},m(e)||(e={username:e,password:r}),t.User.logout({force:!0,silent:!0}).then(function(){var r=t.Persistence.create({namespace:u,collection:n._provider?null:"login",data:e,flags:n._provider?{provider:n._provider}:{},auth:A.App,local:{res:!0}},n).then(function(e){return t.setActiveUser(e),e});return f(r,n)})},logout:function(e){e=e||{};var r;return r=e.silent&&null===t.getActiveUser()?t.Defer.resolve(null):t.Persistence.create({namespace:u,collection:"_logout",auth:A.Session},e).then(null,function(r){return e.force&&t.Error.INVALID_CREDENTIALS===r.name?null:t.Defer.reject(r)}).then(function(){var e=t.setActiveUser(null);return null!==e&&delete e._kmd.authtoken,e}),f(r,e)},me:function(e){e=e||{};var r=t.Persistence.read({namespace:u,collection:"_me",auth:A.Session,local:{res:!0}},e).then(function(e){return e._kmd=e._kmd||{},e._kmd.authtoken=t.getActiveUser()._kmd.authtoken,t.setActiveUser(e),e});return f(r,e)},verifyEmail:function(e,r){r=r||{};var n=t.Persistence.create({namespace:i,collection:e,id:"user-email-verification-initiate",auth:A.App},r);return f(n,r)},forgotUsername:function(e,r){r=r||{};var n=t.Persistence.create({namespace:i,id:"user-forgot-username",data:{email:e},auth:A.App},r);return f(n,r)},resetPassword:function(e,r){r=r||{};var n=t.Persistence.create({namespace:i,collection:e,id:"user-password-reset-initiate",auth:A.App},r);return f(n,r)},exists:function(e,r){r=r||{};var n=t.Persistence.create({namespace:i,id:"check-username-exists",data:{username:e},auth:A.App},r).then(function(e){return e.usernameExists});return f(n,r)},create:function(e,r){r=r||{};var n;return n=!1!==r.state?t.User.logout({force:!0,silent:!0}):t.Defer.resolve(null),n.then(function(){var n=t.Persistence.create({namespace:u,data:e||{},auth:A.App},r).then(function(e){return!1!==r.state&&t.setActiveUser(e),e});return f(n,r)})},update:function(e,r){if(null==e._id)throw new t.Error("data argument must contain: _id");r=r||{};var n=[];if(null!=e._socialIdentity)for(var o in e._socialIdentity)e._socialIdentity.hasOwnProperty(o)&&null!=e._socialIdentity[o]&&o!==r._provider&&(n.push({provider:o,access_token:e._socialIdentity[o].access_token,access_token_secret:e._socialIdentity[o].access_token_secret}),delete e._socialIdentity[o].access_token,delete e._socialIdentity[o].access_token_secret);var i=t.Persistence.update({namespace:u,id:e._id,data:e,auth:A.UserDefault,local:{res:!0}},r).then(function(e){n.forEach(function(r){var t=r.provider;null!=e._socialIdentity&&null!=e._socialIdentity[t]&&["access_token","access_token_secret"].forEach(function(n){null!=r[n]&&(e._socialIdentity[t][n]=r[n])})});var r=t.getActiveUser();return null!==r&&r._id===e._id&&t.setActiveUser(e),e});return f(i,r)},find:function(e,r){if(null!=e&&!(e instanceof t.Query))throw new t.Error("query argument must be of type: Kinvey.Query.");r=r||{};var n;return n=r.discover?t.Persistence.create({namespace:u,collection:"_lookup",data:e?e.toJSON().filter:null,auth:A.Default,local:{req:!0,res:!0}},r):t.Persistence.read({namespace:u,query:e||null,auth:A.Default,local:{req:!0,res:!0}},r),f(n,r)},get:function(e,r){r=r||{};var n=t.Persistence.read({namespace:u,id:e,auth:A.Default,local:{req:!0,res:!0}},r);return f(n,r)},destroy:function(e,r){r=r||{};var n=t.Persistence.destroy({namespace:u,id:e,flags:r.hard?{hard:!0}:{},auth:A.UserDefault,local:{res:!0}},r).then(function(r){var n=t.getActiveUser();return null!==n&&n._id===e&&t.setActiveUser(null),r},function(e){return r.silent&&t.Error.USER_NOT_FOUND===e.name?null:t.Defer.reject(e)});return f(n,r)},restore:function(e,r){r=r||{};var n=t.Persistence.create({namespace:u,collection:e,id:"_restore",auth:A.Master},r);return f(n,r)},count:function(e,r){if(null!=e&&!(e instanceof t.Query))throw new t.Error("query argument must be of type: Kinvey.Query.");r=r||{};var n=t.Persistence.read({namespace:u,id:"_count",query:e||null,auth:A.Default,local:{req:!0}},r).then(function(e){return e.count});return f(n,r)},group:function(e,r){if(!(e instanceof t.Group))throw new t.Error("aggregation argument must be of type: Kinvey.Group.");r=r||{};var n=t.Persistence.create({namespace:u,id:"_group",data:e.toJSON(),auth:A.Default,local:{req:!0}},r).then(function(r){return e.postProcess(r)});return f(n,r)}},t.Query=function(e){e=e||{},this._filter=e.filter||{},this._sort=e.sort||{},this._limit=e.limit||null,this._skip=e.skip||0,this._parent=null},t.Query.prototype={equalTo:function(e,r){return this._filter[e]=r,this},contains:function(e,r){if(!d(r))throw new t.Error("values argument must be of type: Array.");return this._addFilter(e,"$in",r)},containsAll:function(e,r){if(!d(r))throw new t.Error("values argument must be of type: Array.");return this._addFilter(e,"$all",r)},greaterThan:function(e,r){if(!h(r)&&!E(r))throw new t.Error("value argument must be of type: number or string.");return this._addFilter(e,"$gt",r)},greaterThanOrEqualTo:function(e,r){if(!h(r)&&!E(r))throw new t.Error("value argument must be of type: number or string.");return this._addFilter(e,"$gte",r)},lessThan:function(e,r){if(!h(r)&&!E(r))throw new t.Error("value argument must be of type: number or string.");return this._addFilter(e,"$lt",r)},lessThanOrEqualTo:function(e,r){if(!h(r)&&!E(r))throw new t.Error("value argument must be of type: number or string.");return this._addFilter(e,"$lte",r)},notEqualTo:function(e,r){return this._addFilter(e,"$ne",r)},notContainedIn:function(e,r){if(!d(r))throw new t.Error("values argument must be of type: Array.");return this._addFilter(e,"$nin",r)},and:function(){return this._join("$and",Array.prototype.slice.call(arguments))},nor:function(){return null!==this._parent&&null!=this._parent._filter.$and?this._parent.nor.apply(this._parent,arguments):this._join("$nor",Array.prototype.slice.call(arguments))},or:function(){return null!==this._parent?this._parent.or.apply(this._parent,arguments):this._join("$or",Array.prototype.slice.call(arguments))},exists:function(e,r){return r=r===void 0?!0:r||!1,this._addFilter(e,"$exists",r)},mod:function(e,r,n){if(E(r)&&(r=parseFloat(r)),n===void 0?n=0:E(n)&&(n=parseFloat(n)),!h(r))throw new t.Error("divisor arguments must be of type: number.");if(!h(n))throw new t.Error("remainder argument must be of type: number.");return this._addFilter(e,"$mod",[r,n])},matches:function(e,r,t){v(r)||(r=RegExp(r)),t=t||{};var n=[];(r.ignoreCase||t.ignoreCase)&&!1!==t.ignoreCase&&n.push("i"),(r.multiline||t.multiline)&&!1!==t.multiline&&n.push("m"),t.extended&&n.push("x"),t.dotMatchesAll&&n.push("s");var o=this._addFilter(e,"$regex",r.source);return 0!==n.length&&this._addFilter(e,"$options",n.join("")),o},near:function(e,r,n){if(!d(r)||null==r[0]||null==r[1])throw new t.Error("coord argument must be of type: Array.<number, number>.");r[0]=parseFloat(r[0]),r[1]=parseFloat(r[1]);var o=this._addFilter(e,"$near",[r[0],r[1]]);return null!=n&&this._addFilter(e,"$maxDistance",n),o},withinBox:function(e,r,n){if(!d(r)||null==r[0]||null==r[1])throw new t.Error("bottomLeftCoord argument must be of type: Array.<number, number>.");if(!d(n)||null==n[0]||null==n[1])throw new t.Error("upperRightCoord argument must be of type: Array.<number, number>.");r[0]=parseFloat(r[0]),r[1]=parseFloat(r[1]),n[0]=parseFloat(n[0]),n[1]=parseFloat(n[1]);var o=[[r[0],r[1]],[n[0],n[1]]];return this._addFilter(e,"$within",{$box:o})},withinPolygon:function(e,r){if(!d(r)||3>r.length)throw new t.Error("coords argument must be of type: Array.Array.<number, number>.");return r=r.map(function(e){if(null==e[0]||null==e[1])throw new t.Error("coords argument must be of type: Array.Array.<number, number>.");return[parseFloat(e[0]),parseFloat(e[1])]}),this._addFilter(e,"$within",{$polygon:r})},size:function(e,r){if(E(r)&&(r=parseFloat(r)),!h(r))throw new t.Error("size argument must be of type: number.");return this._addFilter(e,"$size",r)},limit:function(e){if(e=e||null,E(e)&&(e=parseFloat(e)),null!=e&&!h(e))throw new t.Error("limit argument must be of type: number.");return null!==this._parent?this._parent.limit(e):this._limit=e,this},skip:function(e){if(E(e)&&(e=parseFloat(e)),!h(e))throw new t.Error("skip argument must be of type: number.");return null!==this._parent?this._parent.skip(e):this._skip=e,this},ascending:function(e){return null!==this._parent?this._parent.ascending(e):this._sort[e]=1,this},descending:function(e){return null!==this._parent?this._parent.descending(e):this._sort[e]=-1,this},sort:function(e){if(null!=e&&!m(e))throw new t.Error("sort argument must be of type: Object.");return null!==this._parent?this._parent.sort(e):this._sort=e||{},this},toJSON:function(){return null!==this._parent?this._parent.toJSON():{filter:this._filter,sort:this._sort,skip:this._skip,limit:this._limit}},_addFilter:function(e,r,t){return m(this._filter[e])||(this._filter[e]={}),this._filter[e][r]=t,this},_join:function(e,r){var n=this;r=r.map(function(e){if(!(e instanceof t.Query)){if(!m(e))throw new t.Error("query argument must be of type: Kinvey.Query[] or Object[].");e=new t.Query(e)}return e.toJSON().filter}),0===r.length&&(n=new t.Query,r=[n.toJSON().filter],n._parent=this);var o={};for(var i in this._filter)this._filter.hasOwnProperty(i)&&(o[i]=this._filter[i],delete this._filter[i]);return this._filter[e]=[o].concat(r),n},_postProcess:function(e){if(!d(e))throw new t.Error("response argument must be of type: Array.");var r=this;return e=e.sort(function(e,t){for(var n in r._sort)if(r._sort.hasOwnProperty(n)){if(e[n]!==void 0&&t[n]===void 0)return-1;if(t[n]!==void 0&&e[n]===void 0)return 1;if(e[n]!==t[n]){var o=r._sort[n];return(e[n]<t[n]?-1:1)*o}}return 0}),null!==this._limit?e.slice(this._skip,this._skip+this._limit):e.slice(this._skip)}};var I=function(e){var r=t.Sync.isEnabled(),n=t.Sync.isOnline();return e.fallback=r&&n&&!1!==e.fallback,e.offline=r&&(!n||e.offline),e.refresh=r&&n&&!1!==e.refresh,e};t.Persistence={create:function(e,r){if(r.relations){var n=u===e.namespace?u:e.collection;return O.save(n,e.data,r)}if(e.local=e.local||{},r=I(r),e.local.req&&r.offline)return t.Persistence.Local.create(e,r).then(null,function(n){return r.fallback&&"_group"===e.id?(r.offline=!1,t.Persistence.create(e,r)):t.Defer.reject(n)});var o=t.Persistence.Net.create(e,r);return e.local.res&&r.refresh?o.then(function(n){return e.data=n,t.Persistence.Local.create(e,r).then(function(){return n})}):o},read:function(e,r){if(e.local=e.local||{},r=I(r),e.local.req&&r.offline)return t.Persistence.Local.read(e,r).then(null,function(n){return r.fallback?(r.offline=!1,t.Persistence.read(e,r)):t.Defer.reject(n)});var n=t.Persistence.Net.read(e,r);return e.local.res&&r.refresh?n.then(function(n){var o;if(r.relations){var i=r.offline;r.offline=!0,r.track=!1;var a=u===e.namespace?u:e.collection;o=O.save(a,n,r).then(function(){r.offline=i,delete r.track})}else e.data=n,o=t.Persistence.Local.create(e,r);return o.then(function(){return n})},function(n){return t.Error.ENTITY_NOT_FOUND===n.name?t.Persistence.Local.destroy(e,r).then(function(){return t.Defer.reject(n)}):t.Defer.reject(n)}):n},update:function(e,r){if(r.relations){var n=u===e.namespace?u:e.collection;return O.save(n,e.data,r)}if(e.local=e.local||{},r=I(r),e.local.req&&r.offline)return t.Persistence.Local.update(e,r);var o=t.Persistence.Net.update(e,r);return e.local.res&&r.refresh?o.then(function(n){return e.data=n,t.Persistence.Local.update(e,r).then(function(){return n})}):o},destroy:function(e,r){if(e.local=e.local||{},r=I(r),e.local.req&&r.offline)return t.Persistence.Local.destroy(e,r);var n=t.Persistence.Net.destroy(e,r);return e.local.res&&r.refresh?n.then(function(n){return t.Persistence.Local.destroy(e,r).then(function(){return n},function(e){return t.Error.ENTITY_NOT_FOUND===e.name?n:t.Defer.reject(e)})}):n}};var T={batch:g("Database.batch"),clean:g("Database.clean"),count:g("Database.count"),destroy:g("Database.destroy"),destruct:g("Database.destruct"),find:g("Database.find"),findAndModify:g("Database.findAndModify"),get:g("Database.get"),group:g("Database.group"),save:g("Database.save"),update:g("Database.update"),use:b(["batch","clean","count","destroy","destruct","find","findAndModify","get","group","save","update"])};t.Persistence.Local={create:function(e,r){r=r||{};var t=u===e.namespace?u:e.collection;if("_group"===e.id)return T.group(t,e.data,r);var n=d(e.data)?"batch":"save",o=T[n](t,e.data,r);return o.then(function(e){return r.offline&&!1!==r.track?w.notify(t,e,r).then(function(){return e}):e})},read:function(e,r){r=r||{};var t=u===e.namespace?u:e.collection;if("_count"===e.id)return T.count(t,e.query,r);var n;return n=null==e.id?T.find(t,e.query,r):T.get(t,e.id,r),n.then(function(e){return r.relations?O.get(e,r):e
})},update:function(e,r){r=r||{};var t=u===e.namespace?u:e.collection,n=T.update(t,e.data,r);return n.then(function(e){return r.offline&&!1!==r.track?w.notify(t,e,r).then(function(){return e}):e})},destroy:function(e,r){r=r||{};var t,n=u===e.namespace?u:e.collection;return t=null==e.id?T.clean(n,e.query,r):T.destroy(n,e.id,r),t.then(function(e){return r.offline&&!1!==r.track?w.notify(n,e.documents,r).then(function(){return e}):e})}},t.Persistence.Net={create:function(e,r){return e.method="POST",t.Persistence.Net._request(e,r)},read:function(e,r){if(r=r||{},r.relations){r.exclude=r.exclude||[];var n=Object.keys(r.relations).filter(function(e){return-1===r.exclude.indexOf(e)});0!==n.length&&(e.flags=e.flags||{},e.flags.retainReferences=!1,e.flags.resolve=n.join(","))}return e.method="GET",t.Persistence.Net._request(e,r)},update:function(e,r){return e.method="PUT",t.Persistence.Net._request(e,r)},destroy:function(e,r){return e.method="DELETE",t.Persistence.Net._request(e,r)},_request:function(e,r){if(null==e.method)throw new t.Error("request argument must contain: method.");if(null==e.namespace)throw new t.Error("request argument must contain: namespace.");if(null==e.auth)throw new t.Error("request argument must contain: auth.");var n;if(null==t.appKey&&A.None!==e.auth)return n=l(t.Error.MISSING_APP_CREDENTIALS),t.Defer.reject(n);if(null==t.masterSecret&&r.skipBL)return n=l(t.Error.MISSING_MASTER_CREDENTIALS),t.Defer.reject(n);var o=[e.namespace,t.appKey,e.collection,e.id];o=o.filter(function(e){return null!=e}).map(t.Persistence.Net.encode);var i=[t.API_ENDPOINT].concat(o).join("/")+"/",u=e.flags||{};if(e.query){var a=e.query.toJSON();u.query=a.filter,null!==a.limit&&(u.limit=a.limit),0!==a.skip&&(u.skip=a.skip),y(a.sort)||(u.sort=a.sort)}r.nocache&&(u._=Math.random().toString(36).substr(2));var s=[];for(var c in u)if(u.hasOwnProperty(c)){var f=E(u[c])?u[c]:JSON.stringify(u[c]);s.push(t.Persistence.Net.encode(c)+"="+t.Persistence.Net.encode(f))}s.length>0&&(i+="?"+s.join("&"));var d={Accept:"application/json","X-Kinvey-API-Version":t.API_VERSION,"X-Kinvey-Device-Information":this.info()};null!=e.data&&(d["Content-Type"]="application/json; charset=utf-8"),r.skipBL&&(d["X-Kinvey-Skip-Business-Logic"]=!0);var p=e.auth().then(function(e){if(null!==e){var r=e.credentials;null!=e.username&&(r=t.Persistence.Net.base64(e.username+":"+e.password)),d.Authorization=e.scheme+" "+r}});return p.then(function(){var n=t.Persistence.Net.request(e.method,i,d,e.data,r);return n.then(null,function(e){return t.Error.INVALID_CREDENTIALS===e.name&&(e.debug="The tokens used to execute the request are expired. Please run `Kinvey.User.logout({ force: true })`, and then log back in using `Kinvey.User.login(username, password)` to solve this issue."),t.Defer.reject(e)})})},base64:g("Kinvey.Persistence.Net.base64"),encode:g("Kinvey.Persistence.Net.encode"),info:g("Kinvey.Persistence.Net.info"),request:g("Kinvey.Persistence.Net.request"),use:b(["base64","encode","info","request"])};var w={enabled:!1,online:!0,system:"system.sync",count:function(e,r){if(r=r||{},null!=e)return T.get(w.system,e,r).then(function(e){return e.size},function(e){return t.Error.ENTITY_NOT_FOUND===e.name?0:t.Defer.reject(e)});var n=t.Group.sum("size").toJSON();return T.group(w.system,n,r).then(function(e){return e[0]?e[0].result:0})},execute:function(e){var r=(new t.Query).greaterThan("size",0);return T.find(w.system,r,e).then(function(r){var n=r.map(function(r){return w._collection(r._id,r.documents,e)});return t.Defer.all(n)})},notify:function(e,r,t){return T.findAndModify(w.system,e,function(t){return r=d(r)?r:[r],t=t||{_id:e,documents:{},size:0},r.forEach(function(e){t.documents.hasOwnProperty(e._id)||(t.size+=1);var r=null!=e._kmd?e._kmd.lmt:null;t.documents[e._id]=r}),t},t).then(function(){return null})},_collection:function(e,r,o){var i={collection:e,success:[],error:[]},a=Object.keys(r),s={namespace:u===e?u:n,collection:u===e?null:e,query:(new t.Query).contains("_id",a),auth:A.Default},c=[t.Persistence.Local.read(s,o),t.Persistence.Net.read(s,o)];return t.Defer.all(c).then(function(e){var r={local:{},net:{}};return e[0].forEach(function(e){r.local[e._id]=e}),e[1].forEach(function(e){r.net[e._id]=e}),r}).then(function(n){var u=a.map(function(t){return w._document(e,{id:t,timestamp:r[t]},n.local[t]||null,n.net[t]||null,o).then(null,function(e){return i.error.push(e.id),null})});return t.Defer.all(u)}).then(function(r){var n=r.filter(function(e){return null!=e&&null!==e.document}),i=r.filter(function(e){return null!=e&&null===e.document}),u=[w._save(e,n,o),w._destroy(e,i,o)];return t.Defer.all(u)}).then(function(r){return i.success=i.success.concat(r[0].success,r[1].success),i.error=i.error.concat(r[0].error,r[1].error),T.findAndModify(w.system,e,function(e){return i.success.forEach(function(r){e.documents.hasOwnProperty(r)&&(e.size-=1,delete e.documents[r])}),e},o)}).then(function(){return i})},_destroy:function(e,r,o){if(r=r.map(function(e){return e.id}),0===r.length)return t.Defer.resolve({success:[],error:[]});var i={namespace:u===e?u:n,collection:u===e?null:e,query:(new t.Query).contains("_id",r),auth:A.Default},a=[t.Persistence.Local.destroy(i,o),t.Persistence.Net.destroy(i,o)];return t.Defer.all(a).then(function(){return{success:r,error:[]}},function(){return{success:[],error:r}})},_document:function(e,r,n,o,i){return null===o||null!=o._kmd&&r.timestamp===o._kmd.lmt?t.Defer.resolve({id:r.id,document:n}):null!=i.conflict?i.conflict(e,n,o).then(function(e){return{id:r.id,document:e}},function(){return t.Defer.reject({id:r.id,document:[n,o]})}):t.Defer.reject({id:r.id,document:[n,o]})},_save:function(e,r,o){r=r.map(function(e){return e.document});var i={namespace:u===e?u:n,collection:u===e?null:e,auth:A.Default},a=[],s=r.map(function(e){return i.id=e._id,i.data=e,t.Persistence.Net.update(i,o).then(null,function(){return a.push(e._id),null})});return t.Defer.all(s).then(function(e){return i.id=null,i.data=e,t.Persistence.Local.create(i,o)}).then(function(e){return{success:e.map(function(e){return e._id}),error:a}},function(){return{success:[],error:r.map(function(e){return e._id})}})}};t.Sync={count:function(e,r){if(!t.Sync.isOnline()){var n=l(t.Error.SYNC_ERROR,{debug:"Sync is not enabled, or the application resides in offline mode."});return t.Defer.reject(n)}r=r||{};var o=w.count(e,r);return f(o,r)},destruct:function(e){e=e||{};var r=T.destruct(e);return f(r,e)},execute:function(e){if(!t.Sync.isOnline()){var r=l(t.Error.SYNC_ERROR,{debug:"Sync is not enabled, or the application resides in offline mode."});return t.Defer.reject(r)}e=e||{};var n;return null!=e.user?(n=t.User.login(e.user).then(function(){return delete e.user,t.Sync.execute(e)}),n.then(null,e.error),n):(n=w.execute(e),f(n,e))},init:function(e){return e=e||{},w.enabled=null!=e?e.enable:!1,w.online=e.online!==void 0?e.online:w.online,t.Defer.resolve(null)},isEnabled:function(){return w.enabled},isOnline:function(){return w.online},offline:function(){if(!t.Sync.isEnabled()){var e=l(t.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return t.Defer.reject(e)}return w.online=!1,t.Defer.resolve(null)},online:function(e){if(!t.Sync.isEnabled()){var r=l(t.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return t.Defer.reject(r)}e=e||{};var n=w.online;return w.online=!0,!1!==e.sync&&n!==w.online?t.Sync.execute(e):t.Defer.resolve(null)},clientAlwaysWins:function(e,r){return t.Defer.resolve(r)},serverAlwaysWins:function(e,r,n){return t.Defer.resolve(n)}},"undefined"!=typeof promiscuous&&t.Defer.use(promiscuous);var k={db:null,dbName:function(){return"Kinvey."+t.appKey},impl:e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,inTransaction:!1,objectID:function(e){e=e||24;for(var r="abcdefghijklmnopqrstuvwxyz0123456789",t="",n=0,o=r.length;e>n;n+=1){var i=Math.floor(Math.random()*o);t+=r.substring(i,i+1)}return t},pending:[],transaction:function(e,r,n,o,i){if(!/^[a-zA-Z0-9\-]{1,128}/.test(e))return o(l(t.Error.INVALID_IDENTIFIER,{description:"The collection name has an invalid format.",debug:"The collection name may only contain alphanumeric characters and dashes."}));if(null===k.dbname)return o(l(t.Error.DATABASE_ERROR,{description:"Missing database name.",debug:"Did you forget to call `IDBAdapter.init`?"}));if(r=r||!1,null!==k.db){if(k.db.objectStoreNames.contains(e)){var u=r?"readwrite":"readonly",a=k.db.transaction([e],u),s=a.objectStore(e);return n(s)}if(!r)return o(l(t.Error.COLLECTION_NOT_FOUND,{description:"This collection not found for this app backend",debug:{collection:e}}))}if(!0!==i&&k.inTransaction)return k.pending.push(function(){k.transaction(e,r,n,o)});k.inTransaction=!0;var c;if(null!==k.db){var f=k.db.version+1;c=k.impl.open(k.db.name,f)}else{if(null==t.appKey)return k.inTransaction=!1,o(l(t.Error.MISSING_APP_CREDENTIALS));c=k.impl.open(k.dbName())}c.onupgradeneeded=function(){k.db=c.result,r&&k.db.createObjectStore(e,{keyPath:"_id"})},c.onsuccess=function(){k.db=c.result,k.db.onversionchange=function(){k.db.close(),k.db=null};var t=function(e){return function(r){var t=e(r);if(k.inTransaction=!1,0!==k.pending.length){var n=k.pending;k.pending=[],n.forEach(function(e){e()})}return t}};k.transaction(e,r,t(n),t(o),!0)},c.onerror=function(e){o(l(t.Error.DATABASE_ERROR,{debug:e}))}},batch:function(e,r){if(0===r.length)return t.Defer.resolve(r);var n=t.Defer.deferred();return k.transaction(e,!0,function(e){var o=e.transaction;r.forEach(function(r){r._id=r._id||k.objectID(),e.put(r)}),o.oncomplete=function(){n.resolve(r)},o.onerror=function(e){var r=l(t.Error.DATABASE_ERROR,{debug:e});n.reject(r)}},function(e){n.reject(e)}),n.promise},clean:function(e,r,n){return null!=r&&r.sort(null).limit(null).skip(0),k.find(e,r,n).then(function(r){if(0===r.length)return{count:0,documents:[]};var n=t.Defer.deferred();return k.transaction(e,!0,function(e){var o=e.transaction;r.forEach(function(r){e["delete"](r._id)}),o.oncomplete=function(){n.resolve({count:r.length,documents:r})},o.onerror=function(e){var r=l(t.Error.DATABASE_ERROR,{debug:e});n.reject(r)}}),n.promise})},count:function(e,r,t){return null!=r&&r.sort(null).limit(null).skip(0),k.find(e,r,t).then(function(e){return{count:e.length}})},destroy:function(e,r){var n=t.Defer.deferred();return k.transaction(e,!0,function(o){var i=o.transaction,u=o.get(r);o["delete"](r),i.oncomplete=function(){return null==u.result?n.reject(l(t.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:e,id:r}})):(n.resolve({count:1,documents:[u.result]}),void 0)},i.onerror=function(e){var r=l(t.Error.DATABASE_ERROR,{debug:e});n.reject(r)}},function(e){n.reject(e)}),n.promise},destruct:function(){if(null==t.appKey){var e=l(t.Error.MISSING_APP_CREDENTIALS);return t.Defer.reject(e)}var r=t.Defer.deferred(),n=k.impl.deleteDatabase(k.dbName());return n.onsuccess=function(){k.db=null,r.resolve(null)},n.onerror=function(e){var n=l(t.Error.DATABASE_ERROR,{debug:e});r.reject(n)},r.promise},find:function(e,r){var n=t.Defer.deferred();return k.transaction(e,!1,function(e){var r=e.openCursor(),o=[];r.onsuccess=function(){var e=r.result;null!=e?(o.push(e.value),e["continue"]()):n.resolve(o)},r.onerror=function(e){n.reject(l(t.DATABASE_ERROR,{debug:e}))}},function(e){return t.Error.COLLECTION_NOT_FOUND===e.name?n.resolve([]):n.reject(e)}),n.promise.then(function(e){return null==r?e:(e=sift(r.toJSON().filter,e),r._postProcess(e))})},findAndModify:function(e,r,n){var o=t.Defer.deferred();return k.transaction(e,!0,function(e){var i=null,u=e.get(r);u.onsuccess=function(){i=n(u.result||null),e.put(i)};var a=e.transaction;a.oncomplete=function(){o.resolve(i)},a.onerror=function(e){var r=l(t.Error.DATABASE_ERROR,{debug:e});o.reject(r)}},function(e){o.reject(e)}),o.promise},get:function(e,r){var n=t.Defer.deferred();return k.transaction(e,!1,function(o){var i=o.get(r);i.onsuccess=function(){return null!=i.result?n.resolve(i.result):(n.reject(l(t.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:e,id:r}})),void 0)},i.onerror=function(e){n.reject(l(t.Error.DATABASE_ERROR,{debug:e}))}},function(o){t.Error.COLLECTION_NOT_FOUND===o.name&&(o=l(t.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:e,id:r}})),n.reject(o)}),n.promise},group:function(e,r,n){var o=r.reduce.replace(/function[\s\S]*?\([\s\S]*?\)/,"");r.reduce=Function(["doc","out"],o);var i=new t.Query({filter:r.condition});return k.find(e,i,n).then(function(e){var t={};e.forEach(function(e){var n={};for(var o in r.key)r.key.hasOwnProperty(o)&&(n[o]=e[o]);var i=JSON.stringify(n);if(null==t[i]){t[i]=n;for(var u in r.initial)r.initial.hasOwnProperty(u)&&(t[i][u]=r.initial[u])}r.reduce(e,t[i])});var n=[];for(var o in t)t.hasOwnProperty(o)&&n.push(t[o]);return n})},save:function(e,r){r._id=r._id||k.objectID();var n=t.Defer.deferred();return k.transaction(e,!0,function(e){var o=e.put(r);o.onsuccess=function(){n.resolve(r)},o.onerror=function(e){var r=l(t.Error.DATABASE_ERROR,{debug:e});n.reject(r)}},function(e){n.reject(e)}),n.promise},update:function(e,r,t){return k.save(e,r,t)}};k.impl!==void 0&&"undefined"!=typeof sift&&(T.use(k),["near","regex","within"].forEach(function(e){sift.useOperator(e,function(){throw new t.Error(e+" query operator is not supported locally.")})}));var U={oAuth1:function(e,r){return U.requestToken(e,r).then(function(e){if(e.error||e.denied){var r=l(t.Error.SOCIAL_ERROR,{debug:e});return t.Defer.reject(r)}return{oauth_token:e.oauth_token,oauth_token_secret:e.oauth_token_secret,oauth_verifier:e.oauth_verifier}}).then(function(n){return t.Persistence.Net.create({namespace:u,data:n,flags:{provider:e,step:"verifyToken"},auth:A.App},r)}).then(function(t){return r._provider=e,t})},oAuth2:function(e,r){return r.state=Math.random().toString(36).substr(2),U.requestToken(e,r).then(function(e){var n;return e.state!==r.state?(n=l(t.Error.SOCIAL_ERROR,{debug:"The state parameters did not match (CSRF attack?)."}),t.Defer.reject(n)):e.error?(n=l(t.Error.SOCIAL_ERROR,{debug:e}),t.Defer.reject(n)):{access_token:e.access_token,expires_in:e.expires_in}})},requestToken:function(r,n){var o=n.redirect||""+e.location;return t.Persistence.Net.create({namespace:u,data:{redirect:o,state:n.state},flags:{provider:r,step:"requestToken"},auth:A.App},n).then(function(r){var o=t.Defer.deferred(),i=e.open(r.url,"KinveyOAuth2"),u=0,a=100,s=e.setInterval(function(){var c;if(null==i.location)e.clearTimeout(s),c=l(t.Error.SOCIAL_ERROR,{debug:"The popup was closed unexpectedly."}),o.reject(c);else if(n.timeout&&u>n.timeout)e.clearTimeout(s),i.close(),c=l(t.Error.SOCIAL_ERROR,{debug:"The user waited too long to reply to the authorization request."}),o.reject(c);else if(i.location.host){e.clearTimeout(s),i.close();var f=i.location,d=f.search.substring(1)+"&"+f.hash.substring(1),p=U.tokenize(d);null!=r.oauth_token_secret&&(p.oauth_token_secret=r.oauth_token_secret),o.resolve(p)}u+=a},a);return o.promise})},tokenize:function(r){var t={};return r.split("&").forEach(function(r){var n=r.split("=",2).map(e.decodeURIComponent);n[0]&&(t[n[0]]=n[1])}),t}};if(t.Social.use(U),"undefined"!=typeof localStorage){var P={_destroy:function(e){return localStorage.removeItem(e),t.Defer.resolve(null)},_get:function(e){var r=localStorage.getItem(e);return t.Defer.resolve(r?JSON.parse(r):null)},_save:function(e,r){return localStorage.setItem(e,JSON.stringify(r)),t.Defer.resolve(null)}};R.use(P)}t.Backbone={getActiveUser:function(){var e=t.getActiveUser();return null!==e?new t.Backbone.User(e):null}},t.Error.NOT_LOGGED_IN="NotLoggedIn",c[t.Error.NOT_LOGGED_IN]={name:t.Error.NOT_LOGGED_IN,description:"This user is not logged in.",debug:""};var j={sync:function(){return t.Backbone.Sync.apply(this,arguments)}},L=function(e,r,t){t=t===void 0?!0:t;var n=r.success;r.success=function(o){if(t)if(e instanceof Backbone.Model){if(!e.set(e.parse(o,r),r))return!1}else{var i=r.reset?"reset":"set";e[i](o,r)}n&&n(e,o,r),t&&e.trigger("sync",e,o,r)};var o=r.error;r.error=function(n){o&&o(e,n,r),t&&e.trigger("error",e,n,r)}},x=function(e,r){var n=e.then(function(e){var t=r.xhr?[r.xhr.statusText,r.xhr]:[];return[e].concat(t)},function(e){var n=r.xhr?[r.xhr.statusText,r.xhr]:[null,null];return t.Defer.reject(n.concat([e]))});if("undefined"==typeof jQuery||jQuery.Deferred===void 0)return n;var o=jQuery.Deferred();return n.then(function(e){o.resolve.apply(o,e)},function(e){o.reject.apply(o,e)}),o.promise()};t.Backbone.ModelMixin=_.extend({},j,{idAttribute:"_id",relations:[]}),t.Backbone.CollectionMixin=_.extend({},j,{query:null,clean:function(e){return e=e?_.clone(e):{},e.parse=e.parse===void 0?!0:e.parse,L(this,e),this.sync("delete",this,e)},count:function(e){e=_.clone(e)||{},e.subject=this,L(this,e,!1);var r,n=_.result(this,"url"),o=e.query||this.query;return r=u===n?t.User.count(o,e):t.DataStore.count(n,o,e),x(r,e)},group:function(e,r){r=_.clone(r)||{},r.subject=this,L(this,r,!1);var n=r.query||this.query;null!=n&&e.query(n);var o,i=_.result(this,"url");return o=u===i?t.User.group(e,r):t.DataStore.group(i,e,r),x(o,r)}});var M=function(e){return function(){return null===this._metadata&&(this._metadata=new t.Metadata(this.attributes)),e.apply(this._metadata,arguments)}};_.extend(t.Backbone.ModelMixin,{_metadata:null,getAcl:M(t.Metadata.prototype.getAcl),getCreatedAt:M(t.Metadata.prototype.getCreatedAt),getLastModified:M(t.Metadata.prototype.getLastModified),setAcl:function(){return M(t.Metadata.prototype.setAcl).apply(this,arguments),this}});var q={url:u};t.Backbone.UserMixin=_.extend({},t.Backbone.ModelMixin,q,{connect:function(e,r){r=r?_.clone(r):{},r.parse=r.parse===void 0?!0:r.parse,r.subject=this,L(this,r);var n=t.Social.connect(this.attributes,e,r);return x(n,r)},disconnect:function(e,r){r=r?_.clone(r):{},r.parse=r.parse===void 0?!0:r.parse,r.subject=this,L(this,r);var n=t.Social.disconnect(this.attributes,e,r);return x(n,r)},getEmailVerification:M(t.Metadata.prototype.getEmailVerification),isLoggedIn:function(){var e=t.getActiveUser();if(null!==e){var r=this.get("_kmd");return null!=r&&r.authtoken===e._kmd.authtoken}return!1},login:function(e,r,n){n=n?_.clone(n):{},n.parse=n.parse===void 0?!0:n.parse,n.subject=this,L(this,n);var o=t.User.login(e,r,n);return x(o,n)},logout:function(e){e=e?_.clone(e):{},e.parse=e.parse===void 0?!0:e.parse,e.subject=this,L(this,e);var r;if(this.isLoggedIn())r=t.User.logout(e);else{var n=l(t.Error.NOT_LOGGED_IN);r=t.Defer.reject(n),f(r,e)}return x(r,e)},me:function(e){e=e?_.clone(e):{},e.parse=e.parse===void 0?!0:e.parse,e.subject=this,L(this,e);var r;if(this.isLoggedIn())r=t.User.me(e);else{var n=l(t.Error.NOT_LOGGED_IN);r=t.Defer.reject(n),f(r,e)}return x(r,e)}}),t.Backbone.StaticUserMixin={verifyEmail:function(e,r){r=r||{};var n=t.User.verifyEmail(e,r);return x(n,r)},forgotUsername:function(e,r){r=r||{};var n=t.User.forgotUsername(e,r);return x(n,r)},resetPassword:function(e,r){r=r||{};var n=t.User.resetPassword(e,r);return x(n,r)},exists:function(e,r){r=r||{};var n=t.User.exists(e,r);return x(n,r)},restore:function(e,r){r=r||{};var n=t.User.restore(e,r);return x(n,r)}},t.Backbone.UserCollectionMixin=_.extend(_.omit(t.Backbone.CollectionMixin,"clean"),q);var C=function(r,n){var o=[],i={},u="read"===r?"autoFetch":"autoSave",a=[],s=function(e,r,t){e.forEach(function(e){a.push({relation:e,depth:r||0,prefix:t||null})})};s(n.relations||[]);for(var c;null!=(c=a.shift());){var l=c.depth,f=c.prefix,d=c.relation;if(10!==l){var p=null;d.relatedModel&&(p=(e[d.relatedModel]||d.relatedModel).prototype);var h=d.collection||_.result(p,"url");if(null==h)throw new t.Error("collection or relatedModel must be set on the relation.");0===h.indexOf("/")&&(h=h.substr(1));var m=null!==f?f+"."+d.key:d.key;i[m]=h,!1===d[u]&&o.push(m),!1===d[u]||null==p||y(p.relations)||s(p.relations,l+1,m)}}return{exclude:o,relations:i}},B=function(e,r,n,o,i){null!=n&&m(o)&&(o._id=n);var a=null==n&&(!m(o)||d(o)),s=u===r?t.User:t.DataStore,c={create:s[u===r?"create":"save"],read:a?s.find:s.get,update:s.update,"delete":a?s.clean:s.destroy},l=[a?i.query:"read"===e||"delete"===e?n:o,i];return u!==r&&l.unshift(r),c[e].apply(s,l)};t.Backbone.Sync=function(e,r,n){n.query=n.query||r.query,n.subject=r;var o=n.silent,i=n.success;n.silent=n.silentFail||!1,n.success=function(e){n.silent=o,i&&i(e)};var u=n.attrs||r.toJSON(n),a=n.url||_.result(r,"url");if(null==a)throw new t.Error("model or options argument must contain: url.");0===a.indexOf("/")&&(a=a.substr(1));var s=a.split("/"),c=s[0],l=s[1]||u._id||null,f=r.model?r.model.prototype.relations:r.relations;if(!y(f)){var d="read"===e?"read":"write";f=C(d,this.model?this.model.prototype:this),n.exclude=f.exclude,n.relations=f.relations}var p=B(e,c,l,u,n);return x(p,n)};var F={deviceInformation:function(){var e=navigator.userAgent.toLowerCase(),r=/(chrome)\/([\w]+)/,t=/(firefox)\/([\w.]+)/,n=/(msie) ([\w.]+)/i,o=/(opera)(?:.*version)?[ \/]([\w.]+)/,i=/(safari)\/([\w.]+)/,u=r.exec(e)||t.exec(e)||n.exec(e)||o.exec(e)||i.exec(e)||[];return["js-backbone/1.0.0-beta",(navigator.platform||"unknown").replace(" ","_").toLowerCase(),u[1]||"unknown",u[2]||"unknown",0].join(" ")}(),base64:function(e){return btoa(e)},encode:encodeURIComponent,info:function(){return F.deviceInformation},request:function(r,n,o,i,u){o=o||{},u=u||{},"GET"===r&&null!=e.location&&null!=e.location.protocol&&(o["X-Kinvey-Origin"]=e.location.protocol+"//"+e.location.host);var a=t.Defer.deferred(),s=function(e,r){var n=e.responseText||null;try{n=JSON.parse(n)}catch(o){}var i=e.status;if(2===parseInt(i/100,10)||304===i)a.resolve(n);else{if(null!=n&&null!=n.error)n={name:n.error,description:n.description||"",debug:n.debug||""};else{var u={abort:t.Error.REQUEST_ABORT_ERROR,error:t.Error.REQUEST_ERROR,timeout:t.Error.REQUEST_TIMEOUT_ERROR},s=u[r]||u.error;n=l(s,{debug:n||e})}a.reject(n)}},c=u.xhr=Backbone.ajax({complete:s,crossDomain:!1,data:i?JSON.stringify(i):null,dataType:"json",headers:o,processData:!1,timeout:u.timeout,type:r,url:n,beforeSend:function(){return u.beforeSend?u.beforeSend.apply(this,arguments):void 0}});if(null!=u.subject){var f=u.subject;delete u.subject,p(f.trigger)&&f.trigger("request",f,c,u)}return a.promise}};"undefined"!=typeof Backbone&&t.Persistence.Net.use(F);var K;return K=Backbone.AssociatedModel!==void 0?Backbone.AssociatedModel:Backbone.Model,t.Backbone.Model=K.extend(t.Backbone.ModelMixin),t.Backbone.Collection=Backbone.Collection.extend(_.extend({},t.Backbone.CollectionMixin,{model:t.Backbone.Model,initialize:function(e,r){var n=Backbone.Collection.prototype.initialize.apply(this,arguments);if(r=r||{},null!=r.query&&!(r.query instanceof t.Query))throw new t.Error("options.query argument must be of type: Kinvey.Query.");return this.query=r.query||null,n}})),t.Backbone.User=K.extend(t.Backbone.UserMixin,t.Backbone.StaticUserMixin),t.Backbone.UserCollection=Backbone.Collection.extend(_.extend({},t.Backbone.UserCollectionMixin,{model:t.Backbone.User,initialize:t.Backbone.Collection.prototype.initialize})),t},t=r();"object"==typeof module&&"object"==typeof module.exports?module.exports=t:"function"==typeof define&&define.amd?define("Kinvey",[],function(){return t}):e.Kinvey=t}).call(this);